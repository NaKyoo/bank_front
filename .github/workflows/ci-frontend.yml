name: CI Frontend - Tests Automatisés

# Déclenchement sur push vers la branche github-action
on:
  push:
    branches:
      - github-action

jobs:
  test-frontend:
    runs-on: ubuntu-latest
    
    steps:
      # Étape 1 : Récupération du code source
      - name: Checkout code
        uses: actions/checkout@v5

      # Étape 2 : Configuration de Node.js v20
      - name: Set up Node.js 20
        uses: actions/setup-node@v5
        with:
          node-version: '20'
          cache: 'npm'

      # Étape 3 : Installation des dépendances
      - name: Install dependencies
        run: npm ci

      # Étape 4 : Exécution des tests
      - name: Run tests
        id: tests
        run: npm test

      # Étape 5 : Création d'une issue en cas d'échec (notification automatique)
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '❌ Échec des tests CI - ' + context.sha.substring(0, 7),
              body: `## Échec des tests automatisés
              
              **Branche :** \`${context.ref.replace('refs/heads/', '')}\`
              **Commit :** ${context.sha}
              **Auteur :** @${context.actor}
              **Message :** ${context.payload.head_commit.message}
              
              ### Détails
              Les tests ont échoué lors de l'exécution du workflow CI.
              
              **Logs :** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              
              ---
              *Cette issue a été créée automatiquement par GitHub Actions*`,
              labels: ['bug', 'ci-failure']
            });
            console.log('Issue créée : #' + issue.data.number);
