# ============================================================================
# CI Frontend - Pipeline d'Intégration Continue pour Tests Automatisés
# ============================================================================
# 
# Description:
#   Ce workflow GitHub Actions exécute automatiquement les tests unitaires
#   du projet frontend React/Vite à chaque push sur la branche github-action.
#   En cas d'échec, une issue GitHub est créée automatiquement avec tous
#   les détails nécessaires pour le débogage.
#
# Auteur: DevOps Team
# Date de création: 2025-12-18
# Version: 1.0.0
# ============================================================================

name: CI Frontend - Tests Automatisés

# ----------------------------------------------------------------------------
# Configuration des Déclencheurs (Triggers)
# ----------------------------------------------------------------------------
# Le workflow se déclenche automatiquement lors d'un push sur la branche
# 'github-action'. Cela permet de tester les changements avant de les
# merger dans la branche principale.
on:
  push:
    branches:
      - github-action

# ----------------------------------------------------------------------------
# Définition des Jobs
# ----------------------------------------------------------------------------
jobs:
  # Job principal: test-frontend
  # Exécute les tests unitaires dans un environnement Ubuntu
  test-frontend:
    runs-on: ubuntu-latest
    
    steps:
      # ======================================================================
      # Étape 1: Récupération du Code Source
      # ======================================================================
      # Utilise l'action officielle checkout@v5 pour cloner le dépôt
      # dans l'environnement d'exécution GitHub Actions
      - name: Checkout code
        uses: actions/checkout@v5

      # ======================================================================
      # Étape 2: Configuration de l'Environnement Node.js
      # ======================================================================
      # Installe Node.js version 20 (LTS) pour exécuter les commandes npm
      # Le cache npm accélère les installations futures en réutilisant
      # les dépendances déjà téléchargées
      - name: Set up Node.js 20
        uses: actions/setup-node@v5
        with:
          node-version: '20'
          cache: 'npm'

      # ======================================================================
      # Étape 3: Installation des Dépendances
      # ======================================================================
      # Utilise 'npm ci' (clean install) au lieu de 'npm install'
      # Avantages:
      #   - Plus rapide en CI/CD
      #   - Installation déterministe basée sur package-lock.json
      #   - Supprime node_modules existant avant installation
      - name: Install dependencies
        run: npm ci

      # ======================================================================
      # Étape 4: Exécution des Tests Unitaires
      # ======================================================================
      # Lance les tests avec Vitest en mode run (exécution unique)
      # L'ID 'tests' permet de référencer cette étape dans les étapes suivantes
      # Si les tests échouent, le workflow s'arrête et passe à l'étape de notification
      - name: Run tests
        id: tests
        run: npm test

      # ======================================================================
      # Étape 5: Notification en Cas d'Échec (Feedback Automatique)
      # ======================================================================
      # Cette étape ne s'exécute QUE si une étape précédente a échoué
      # Crée automatiquement une issue GitHub avec:
      #   - Le hash du commit fautif
      #   - L'auteur du commit
      #   - Le message de commit
      #   - Un lien direct vers les logs du workflow
      #
      # Avantages DevOps:
      #   - Feedback immédiat aux développeurs (Time to Value réduit)
      #   - Traçabilité complète des échecs
      #   - Aucune configuration de secrets nécessaire (utilise GITHUB_TOKEN)
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            // Création d'une issue GitHub via l'API REST
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '❌ Échec des tests CI - ' + context.sha.substring(0, 7),
              body: `## Échec des tests automatisés
              
              **Branche :** \`${context.ref.replace('refs/heads/', '')}\`
              **Commit :** ${context.sha}
              **Auteur :** @${context.actor}
              **Message :** ${context.payload.head_commit.message}
              
              ### Détails
              Les tests ont échoué lors de l'exécution du workflow CI.
              
              **Logs :** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              
              ---
              *Cette issue a été créée automatiquement par GitHub Actions*`,
              labels: ['bug', 'ci-failure']
            });
            console.log('Issue créée : #' + issue.data.number);

