<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: hooks/useAccounts.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: hooks/useAccounts.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// ============================================================================
// Hook Custom - Gestion des Comptes Bancaires
// ============================================================================
// 
// Description:
//   Hook React personnalis√© pour g√©rer l'√©tat et les op√©rations sur les
//   comptes bancaires de l'utilisateur connect√©. G√®re la r√©cup√©ration,
//   la cr√©ation, la suppression et les transferts entre comptes.
//
// Fonctionnalit√©s:
//   - R√©cup√©ration automatique des comptes au montage du composant
//   - D√©duplication automatique des comptes (protection contre les doublons backend)
//   - Gestion des op√©rations CRUD (Create, Read, Update, Delete)
//   - Mise √† jour optimiste du solde lors des virements
//   - Gestion des √©tats de chargement et d'erreur
//
// Utilisation:
//   const { accounts, loading, error, openAccount, deleteAccount, ... } = useAccounts();
//
// ============================================================================

import { useState, useEffect } from "react";
import { accountService } from "../api/accountService";

/**
 * Hook personnalis√© pour g√©rer les comptes bancaires de l'utilisateur
 * 
 * @returns {Object} Objet contenant:
 *   - accounts: Array - Liste des comptes uniques de l'utilisateur
 *   - loading: Boolean - √âtat de chargement initial
 *   - error: String|null - Message d'erreur √©ventuel
 *   - actionLoading: Boolean - √âtat de chargement des actions (create/delete)
 *   - closeAccount: Function - Ferme un compte (change is_active √† false)
 *   - archiveAccount: Function - Archive un compte
 *   - deleteAccount: Function - Supprime un compte (close + archive)
 *   - openAccount: Function - Ouvre un nouveau compte
 *   - applyTransfer: Function - Met √† jour les soldes apr√®s un virement
 *   - refresh: Function - Rafra√Æchit la liste des comptes
 */
export const useAccounts = () => {
  const [accounts, setAccounts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [actionLoading, setActionLoading] = useState(false);
  const [error, setError] = useState(null);

  /**
   * R√©cup√®re les comptes depuis l'API backend
   * Applique un filtre de d√©duplication pour √©viter les doublons
   * 
   * Note: Le backend peut renvoyer des comptes en double (m√™me account_number).
   * Ce filtre garantit que seul le premier compte de chaque account_number
   * est conserv√©, prot√©geant ainsi l'interface contre les erreurs de cl√© React.
   */
  const fetchAccounts = async () => {
    setLoading(true);
    setError(null);
    try {
      let data = await accountService.getMyAccounts();

      // üîç DEBUG: Logs pour v√©rifier les donn√©es re√ßues du backend
      console.log("üìä Comptes re√ßus du backend:", data);
      console.log("üìä Nombre de comptes:", data.length);
      console.log("üìä Account numbers:", data.map(acc => acc.account_number));

      // üõ°Ô∏è PROTECTION: Filtrage des doublons bas√© sur account_number
      // Utilise reduce() pour construire un tableau sans doublons
      // en v√©rifiant si chaque account_number existe d√©j√†
      const uniqueAccounts = data.reduce((acc, current) => {
        const exists = acc.find(item => item.account_number === current.account_number);
        if (!exists) {
          return acc.concat([current]);
        }
        // Log un warning si un doublon est d√©tect√©
        console.warn(`‚ö†Ô∏è Doublon d√©tect√© et ignor√©: ${current.account_number}`);
        return acc;
      }, []);

      console.log("‚úÖ Comptes uniques apr√®s filtrage:", uniqueAccounts.length);

      setAccounts(uniqueAccounts);
    } catch (err) {
      setError(err.message || "Erreur lors de la r√©cup√©ration des comptes");
    } finally {
      setLoading(false);
    }
  };

  /**
   * Effet de montage: R√©cup√®re les comptes au chargement du composant
   */
  useEffect(() => {
    fetchAccounts();
  }, []);

  /**
   * Ferme un compte bancaire (met is_active √† false)
   * 
   * @param {string} accountNumber - Num√©ro du compte √† fermer
   * @returns {Promise&lt;Object>} Donn√©es du compte ferm√©
   * @throws {Error} Si la fermeture √©choue
   */
  const closeAccount = async (accountNumber) => {
    setActionLoading(true);
    setError(null);
    try {
      return await accountService.closeAccount(accountNumber);
    } catch (err) {
      setError(err.message || "Erreur lors de la cl√¥ture du compte");
      throw err;
    } finally {
      setActionLoading(false);
    }
  };

  /**
   * Archive un compte bancaire
   * 
   * @param {string} accountNumber - Num√©ro du compte √† archiver
   * @param {string} reason - Raison de l'archivage (optionnel)
   * @returns {Promise&lt;Object>} Donn√©es du compte archiv√©
   * @throws {Error} Si l'archivage √©choue
   */
  const archiveAccount = async (accountNumber, reason = "Cl√¥ture du compte") => {
    setActionLoading(true);
    setError(null);
    try {
      return await accountService.archiveAccount(accountNumber, reason);
    } catch (err) {
      setError(err.message || "Erreur lors de l'archivage du compte");
      throw err;
    } finally {
      setActionLoading(false);
    }
  };

  /**
   * Supprime compl√®tement un compte (fermeture + archivage)
   * Rafra√Æchit automatiquement la liste apr√®s suppression
   * 
   * Note: Ne peut supprimer que les comptes actifs (is_active: true)
   * 
   * @param {string} accountNumber - Num√©ro du compte √† supprimer
   * @returns {Promise&lt;boolean>} true si succ√®s, false sinon
   */
  const deleteAccount = async (accountNumber) => {
    setActionLoading(true);
    setError(null);
    try {
      // V√©rifier si le compte est actif avant de tenter la suppression
      const account = accounts.find(acc => acc.account_number === accountNumber);
      if (!account) {
        throw new Error("Compte introuvable");
      }
      if (!account.is_active) {
        throw new Error("Ce compte est d√©j√† inactif et ne peut pas √™tre supprim√©");
      }

      await closeAccount(accountNumber);
      await archiveAccount(accountNumber, "Cl√¥ture manuelle");
      await fetchAccounts();
      return true;
    } catch (err) {
      setError(err.message);
      console.error("‚ùå Erreur lors de la suppression:", err.message);
      return false;
    } finally {
      setActionLoading(false);
    }
  };

  /**
   * Ouvre un nouveau compte bancaire
   * Rafra√Æchit automatiquement la liste apr√®s cr√©ation
   * 
   * @param {string} account_number - Num√©ro du nouveau compte
   * @param {string} parent_account_number - Num√©ro du compte parent (pour comptes secondaires)
   * @param {number} initial_balance - Solde initial (d√©faut: 0)
   * @returns {Promise&lt;Object>} Donn√©es du compte cr√©√©
   * @throws {Error} Si la cr√©ation √©choue
   */
  const openAccount = async (account_number, parent_account_number, initial_balance = 0) => {
    setActionLoading(true);
    setError(null);
    try {
      console.log("üîÑ Cr√©ation du compte:", { account_number, parent_account_number, initial_balance });
      const newAccount = await accountService.openAccount({ account_number, parent_account_number, initial_balance });
      console.log("‚úÖ Compte cr√©√©:", newAccount);

      // Rafra√Æchir la liste des comptes
      await fetchAccounts();

      return newAccount;
    } catch (err) {
      const errorMsg = err.message || "Erreur lors de l'ouverture du compte";
      setError(errorMsg);
      console.error("‚ùå Erreur lors de la cr√©ation:", errorMsg);
      throw err;
    } finally {
      setActionLoading(false);
    }
  };

  /**
   * Applique un virement entre comptes (mise √† jour optimiste)
   * Met √† jour les soldes localement sans attendre la confirmation backend
   * 
   * Cette approche optimiste am√©liore l'UX en affichant imm√©diatement
   * les nouveaux soldes, sans attendre la r√©ponse du serveur.
   * 
   * @param {Object} transferData - Donn√©es du virement
   * @param {string} transferData.from_account - Compte source
   * @param {string} transferData.to_account - Compte destination
   * @param {number} transferData.amount - Montant du virement
   */
  const applyTransfer = ({ from_account, to_account, amount }) => {
    const value = Number(amount);
    if (Number.isNaN(value) || value === 0) return;

    setAccounts((prev) =>
      prev.map((acc) => {
        // D√©biter le compte source
        if (acc.account_number === from_account) {
          const current = Number(acc.balance) || 0;
          return { ...acc, balance: current - value };
        }
        // Cr√©diter le compte destination
        if (acc.account_number === to_account) {
          const current = Number(acc.balance) || 0;
          return { ...acc, balance: current + value };
        }
        return acc;
      })
    );
  };

  // Retour de l'interface publique du hook
  return {
    accounts,
    loading,
    error,
    actionLoading,
    closeAccount,
    archiveAccount,
    deleteAccount,
    openAccount,
    applyTransfer,
    refresh: fetchAccounts,
  };
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#parseDate">parseDate</a></li><li><a href="global.html#useAccounts">useAccounts</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Fri Dec 19 2025 08:24:10 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
